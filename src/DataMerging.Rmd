---
title: "Data Merging"
author: "DSE Group 3"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Importing relevant packages**
```{r, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
```

**Importing all cleaned data**
```{r}
annualEmployment <- readRDS("../cleaned_data/annualEmployment.rds")
indivCPS <- readRDS("../cleaned_data/indivCPS.rds")
medianWage <- readRDS("../cleaned_data/medianWage.rds")
policyImplementation <- readRDS("../cleaned_data/policyImplementation.rds")
```

#### **Merge CPS with unemployment**

**Making sure both STATEFIP and YEAR are numeric type**
```{r}
annualEmployment <- annualEmployment %>%
  mutate(
    STATEFIP = as.numeric(STATEFIP),
    YEAR = as.numeric(YEAR)
  )

head(annualEmployment)
```
**Checking there are no potential missing entries due to the merge**
```{r}
sum(is.na(indivCPS$STATEFIP) | is.na(indivCPS$YEAR))
sum(is.na(annualEmployment$STATEFIP) | is.na(annualEmployment$YEAR))

annualEmployment %>%
  count(STATEFIP, YEAR) %>%
  filter(n > 1)

anti_join(indivCPS, annualEmployment, by = c("STATEFIP", "YEAR")) %>%
  distinct(STATEFIP, YEAR)

# Checked all above, this one most important (shows observations in annualEmployment that isn't in indivCPS)
anti_join(annualEmployment, indivCPS, by = c("STATEFIP", "YEAR")) %>%
  distinct(YEAR)
# Only extra entries are the years not accounted for in our project (pre 1982 and post 2011)
```
**Finally, merge CPS with unemployment data (by YEAR, STATEFIP)**
```{r}
mergedData1 <- indivCPS %>%
  left_join(annualEmployment, by = c("STATEFIP", "YEAR"))

head(mergedData1)
```
#### **Merge with median weekly wage**
**Checks before merging**
```{r}
sum(is.na(medianWage$STATEFIP)  | is.na(medianWage$YEAR))
medianWage %>% count(STATEFIP, YEAR) %>% filter(n > 1)
anti_join(mergedData1, medianWage, by=c("STATEFIP","YEAR")) %>% distinct(STATEFIP,YEAR)
anti_join(medianWage, mergedData1, by=c("STATEFIP","YEAR")) %>% distinct(STATEFIP,YEAR) 

```


**Finally, merge with median wage**
```{r}
mergedData2 <- mergedData1 %>%
  left_join(medianWage, by = c("STATEFIP", "YEAR"))

head(mergedData2)
```

#### **Merge with policy implementation year**
```{r}
head(policyImplementation)
```
**Rename column names to be equivalent first**
```{r}
policyImplementation <- policyImplementation %>%
  rename(
    STATE = State,
    YEAR = year
  )

head(policyImplementation)
```
**Pre-merger checks, same as earlier**
```{r}
sum(is.na(policyImplementation$STATE) | is.na(policyImplementation$YEAR))
sum(is.na(mergedData2$STATE) | is.na(mergedData2$YEAR))
policyImplementation %>% count(STATE, YEAR) %>% filter(n > 1)

anti_join(mergedData2, policyImplementation, by=c("STATE","YEAR")) %>% distinct(STATE,YEAR)
anti_join(policyImplementation, mergedData2, by=c("STATE","YEAR")) %>% distinct(STATE)
```
```{r}
mergedData3 <- mergedData2 %>%
  left_join(policyImplementation, by = c("STATE", "YEAR"))

head(mergedData3)
```
```{r}
saveRDS(mergedData3, "../cleaned_data/finalmerged.rds")
```

