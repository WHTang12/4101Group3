title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = emp_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +
labs(
title = "Average Employment Rate by Treatment Status",
x = "Year", y = "Employment Rate (%)",
color = "Treated"
) +
theme_minimal()
pretrend_test <- lm(
birth_lastyear ~ treated * YEAR,
data = df_final %>%
filter(YEAR < treat_start_year | is.na(treat_start_year))
)
pretrend_test <- lm(
birth_lastyear ~ treated * YEAR,
data = df1 %>%
filter(YEAR < treat_start_year | is.na(treat_start_year))
)
summary(pretrend_test)
df_pre <- df1 %>%
mutate(time = YEAR - 1992)
pretrend_fe <- feols(
birth_lastyear ~ treated * time | STATEFIP,
cluster = ~STATEFIP,
data = df_pre
)
library(fixest)
df_pre <- df1 %>%
mutate(time = YEAR - 1992)
pretrend_fe <- feols(
birth_lastyear ~ treated * time | STATEFIP,
cluster = ~STATEFIP,
data = df_pre
)
summary(pretrend_fe)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
library(tidyverse)
library(lubridate)
library(ggplot2)
# Import data
df <- readRDS("../cleaned_data/finalmerged.rds")
# Filter only for years where it's before repeal_year
df1 <- df %>%
filter(is.na(repeal_year) | YEAR <= repeal_year)
df_stateyear <- df1 %>%
group_by(YEAR, ever_treated) %>%
summarise(
birth_rate = mean(birth_lastyear, na.rm = TRUE) * 1000,
emp_rate   = mean(employed, na.rm = TRUE) * 100
) %>%
ungroup()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +   # earliest year of policy implementation
labs(
title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +   # earliest year of policy implementation
labs(
title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +   # earliest year of policy implementation
labs(
title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
#stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +   # earliest year of policy implementation
labs(
title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
stat_summary(fun = mean, geom = "line", size = 1) +       # averages across groups
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year",
y = "Births per 1,000 Women",
color = "Ever Treated"
) +
scale_color_manual(values = c("0" = "steelblue", "1" = "firebrick")) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
View(df1)
df1 %>%
filter(ever_treated == 1) %>%
distinct(STATE)
print(df1 %>%
filter(ever_treated == 1) %>%
distinct(STATE))
print(df1 %>%
filter(ever_treated == 1) %>%
distinct(STATE), n = 100
)
print(df1 %>%
filter(ever_treated == 1) %>%
distinct(STATE) %>%
arrange(STATE), n = 100
)
dfxd <- readRDS("../cleaned_data/policyImplementation.rds")
View(dfxd)
View(df_stateyear)
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate,
color = factor(ever_treated, labels = c("Never treated states", "Treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("steelblue", "firebrick")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +   # earliest year of policy implementation
labs(
title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = emp_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +
labs(
title = "Average Employment Rate by Treatment Status",
x = "Year", y = "Employment Rate (%)",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate,
color = factor(ever_treated, labels = c("Never treated states", "Treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("steelblue", "firebrick")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate,
color = factor(ever_treated, levels = c(1, 0),
labels = c("Treated states", "Never treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("firebrick", "steelblue")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
df_stateyear <- df1 %>%
group_by(YEAR, ever_treated) %>%
summarise(
birth_rate = weighted.mean(birth_lastyear, ASECWT, na.rm = TRUE) * 1000,
emp_rate   = weighted.mean(employed, ASECWT, na.rm = TRUE) * 100
) %>%
ungroup()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +   # earliest year of policy implementation
labs(
title = "Average Annual Birth Rates by Treatment Status",
x = "Year", y = "Births per 1,000 Women",
color = "Treated"
) +
theme_minimal()
View(df_stateyear)
ggplot(df_stateyear, aes(x = YEAR, y = emp_rate, color = factor(ever_treated))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed") +
labs(
title = "Average Employment Rate by Treatment Status",
x = "Year", y = "Employment Rate (%)",
color = "Treated"
) +
theme_minimal()
ggplot(df_stateyear, aes(x = YEAR, y = birth_rate,
color = factor(ever_treated, levels = c(1, 0),
labels = c("Treated states", "Never treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("firebrick", "steelblue")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
df_stateyear <- df1 %>%
group_by(YEAR, ever_treated) %>%
summarise(
birth_rate = weighted.mean(birth_lastyear, ASECWT, na.rm = TRUE) * 1000,
emp_rate   = weighted.mean(employed, ASECWT, na.rm = TRUE) * 100
) %>%
ungroup()
View(df_stateyear)
df_stateyear <- df1 %>%
group_by(YEAR, ever_treated) %>%
summarise(
birth_rate = weighted.mean(birth_lastyear, na.rm = TRUE) * 1000,
emp_rate   = weighted.mean(employed, ASECWT, na.rm = TRUE) * 100
) %>%
ungroup()
View(df_stateyear)
ggplot(df_stateyear, aes(x = YEAR, y = empl_rate,
color = factor(ever_treated, levels = c(1, 0),
labels = c("Treated states", "Never treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("firebrick", "steelblue")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
ggplot(df_stateyear, aes(x = YEAR, y = empl_rate,
color = factor(ever_treated, levels = c(1, 0),
labels = c("Treated states", "Never treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("firebrick", "steelblue")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
ggplot(df_stateyear, aes(x = YEAR, y = emp_rate,
color = factor(ever_treated, levels = c(1, 0),
labels = c("Treated states", "Never treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Birth Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("firebrick", "steelblue")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
ggplot(df_stateyear, aes(x = YEAR, y = emp_rate,
color = factor(ever_treated, levels = c(1, 0),
labels = c("Treated states", "Never treated states")))) +
geom_line(size = 1) +
geom_vline(xintercept = 1992, linetype = "dashed", color = "black") +
labs(
title = "Average Annual Unemployment Rates by Treatment Status",
subtitle = "Visual Pre-Trend Check (Dashed Line = Earliest Policy Year)",
x = "Year", y = "Births per 1,000 Women", color = "Group"
) +
scale_color_manual(values = c("firebrick", "steelblue")) +
theme_minimal(base_size = 13) +
theme(panel.grid.minor = element_blank(), legend.position = "bottom")
lm(birth_rate ~ treated*post_pretrend, data = subset(df, YEAR < 1992))
lm(birth_rate ~ treated*post_pretrend, data = subset(df_stateyear, YEAR < 1992))
lm(birth_rate ~ ever_treated, data = subset(df_stateyear, YEAR < 1992))
summary(lm(birth_rate ~ ever_treated, data = subset(df_stateyear, YEAR < 1992)))
df_diff <- df1 %>%
group_by(YEAR, ever_treated) %>%
summarise(birth = weighted.mean(birth_lastyear, ASECWT, na.rm=TRUE) * 1000,
.groups="drop") %>%
pivot_wider(names_from = ever_treated, values_from = birth) %>%
mutate(diff = `1` - `0`)
ggplot(df_diff, aes(x = YEAR, y = diff)) +
geom_line() +
geom_point() +
geom_errorbar(aes(ymin = diff - se, ymax = diff + se), width = 0.3) +
geom_vline(xintercept = 1992, linetype = "dashed") +
labs(y = "Difference in birth rates\n(Treated - Untreated)", x = "Year") +
theme_minimal()
df_diff <- df1 %>%
group_by(YEAR, ever_treated, STATEFIP) %>%
summarise(birth = weighted.mean(birth_lastyear, ASECWT, na.rm = TRUE) * 1000,
.groups = "drop_last") %>%
summarise(
mean_birth = mean(birth),
se_birth   = sd(birth) / sqrt(n()),
.groups = "drop"
) %>%
pivot_wider(names_from = ever_treated, values_from = c(mean_birth, se_birth)) %>%
mutate(
diff = mean_birth_1 - mean_birth_0,
se   = sqrt(se_birth_1^2 + se_birth_0^2)
)
ggplot(df_diff, aes(x = YEAR, y = diff)) +
geom_line() +
geom_point() +
geom_errorbar(aes(ymin = diff - se, ymax = diff + se), width = 0.3) +
geom_vline(xintercept = 1992, linetype = "dashed") +
labs(y = "Difference in birth rates\n(Treated - Untreated)", x = "Year") +
theme_minimal()
df_diff_emp <- df1 %>%
group_by(YEAR, ever_treated, STATEFIP) %>%
summarise(emp = weighted.mean(employed, ASECWT, na.rm = TRUE) * 100,
.groups = "drop_last") %>%
summarise(
mean_emp = mean(emp),
se_emp   = sd(emp) / sqrt(n()),
.groups = "drop"
) %>%
pivot_wider(names_from = ever_treated, values_from = c(mean_emp, se_emp)) %>%
mutate(
diff = mean_emp_1 - mean_emp_0,
se   = sqrt(se_emp_1^2 + se_emp_0^2)
)
ggplot(df_diff_emp, aes(x = YEAR, y = diff)) +
geom_line() +
geom_point() +
geom_errorbar(aes(ymin = diff - se, ymax = diff + se), width = 0.3) +
geom_vline(xintercept = 1992, linetype = "dashed") +
labs(y = "Difference in employment rates\n(Treated - Untreated)", x = "Year") +
theme_minimal()
df2 <- df_stateyear %>%
mutate(event_time = YEAR - treat_start_year)
read.csv("../data/2025-09-MD.csv")
getwd()
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(did)
df <- readRDS("../cleaned_data/finalmerged.rds")
df1 <- df %>%
filter(is.na(repeal_year) | YEAR <= repeal_year)
colnames(df1)
df1$treat_start_year[is.na(df1$treat_start_year)] <- 0
att_cs <- att_gt(
yname   = "birth_lastyear",
tname   = "YEAR",
gname   = "treat_start_year",
xformla = ~ AGE + NCHILD + EDUC + RACE + MARST,
control_group = "nevertreated",
weightsname = "ASECWT",
data    = df1,
panel = F,
clustervars = "STATEFIP"
)
View(df1)
View(df1)
summary(att_cs)
agg_cs <- aggte(att_cs, type = "group")
summary(agg_cs)
agg_dyn <- aggte(att_cs, type = "dynamic")
summary(agg_dyn)
ggdid(agg_dyn)
library(fixest)
# 2) EVENT-STUDY (Sun–Abraham), binary outcome → LPM
#    Keep INDIVIDUAL covariates; cluster at state; add state & year FE
m_birth <- feols(
birth_lastyear ~ sunab(treat_start_year, YEAR) + AGE + EDUC + RACE + MARST |
STATEFIP + YEAR,
data = df1,
weights = ~ASECWT,           # drop this line if you don't want weights
cluster = ~STATEFIP
)
summary(m_birth)
etable(m_birth, se = "cluster")
post <- coef(m_birth)[grepl("event::", names(coef(m_birth))) & !grepl("event_\\-", names(coef(m_birth)))]
mean(post)   # simple average of post coefficients
iplot(m_birth, ref.line = 0, xlab = "Event time (years)", main = "Births < 1 (SA event-study)")
knitr::opts_chunk$set(echo = TRUE)
df2 <- df1 %>%
select(YEAR, STATE, ever_treated, treat_start_year, treated, everything())
View(df2)
df2 <- df1 %>%
select(YEAR, STATE, ever_treated, treat_start_year, treated, UNEMPLOYMENTRATE, median_weekly_wage, everything())
df2 <- df1 %>%
select(YEAR, STATE, ever_treated, treat_start_year, treated, UNEMPLOYMENTRATE, median_weekly_wage, everything()) %>%
filter(STATE = "Maine")
df2 <- df1 %>%
select(YEAR, STATE, ever_treated, treat_start_year, treated, UNEMPLOYMENTRATE, median_weekly_wage, everything()) %>%
filter(STATE == "Maine")
gc()
library(tidyverse)
library(lubridate)
library(did)
df <- readRDS("../cleaned_data/finalmerged.rds")
df1 <- df %>%
filter(is.na(repeal_year) | YEAR <= repeal_year)
df1$treat_start_year[is.na(df1$treat_start_year)] <- 0
colnames(df1)
